<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expiry Alerts - General Store Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="nav-brand">
            <span>üè™ General Store</span>
        </div>
        <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
    </nav>
    
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üè™ General Store</h2>
                <p>Stock Management</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="{{ url_for('dashboard') }}" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('add_product') }}" class="nav-item">
                    <span class="nav-icon">‚ûï</span>
                    <span>Add Product</span>
                </a>
                <a href="{{ url_for('view_stock') }}" class="nav-item">
                    <span class="nav-icon">üì¶</span>
                    <span>View Stock</span>
                </a>
                <a href="{{ url_for('expiry_alert') }}" class="nav-item active">
                    <span class="nav-icon">‚ö†Ô∏è</span>
                    <span>Expiry Alerts</span>
                </a>
                <a href="{{ url_for('pending_suppliers') }}" class="nav-item">
                    <span class="nav-icon">üí∞</span>
                    <span>Pending Payments</span>
                </a>
                <a href="{{ url_for('logout') }}" class="nav-item logout">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>Expiry Alerts</h1>
                <p>Monitor products approaching or past their expiry dates</p>
            </header>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Alert Summary Cards -->
            <div class="alert-summary">
                <div class="alert-card danger">
                    <div class="alert-icon">üö®</div>
                    <div class="alert-content">
                        <h3>{{ expired_items|length }}</h3>
                        <p>Expired Items</p>
                    </div>
                </div>
                
                <div class="alert-card warning">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-content">
                        <h3>{{ near_expiry_items|length }}</h3>
                        <p>Near Expiry (‚â§7 days)</p>
                    </div>
                </div>
            </div>
            
            <!-- Expired Items Section -->
            <section class="expiry-section">
                <h2>üö® Expired Items</h2>
                {% if expired_items %}
                    <div class="table-container">
                        <table class="expiry-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Supplier</th>
                                    <th>Expiry Date</th>
                                    <th>Days Expired</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in expired_items %}
                                <tr class="expired-row">
                                    <td>{{ item.product_name }}</td>
                                    <td>{{ item.category }}</td>
                                    <td>{{ item.quantity }} {{ item.unit }}</td>
                                    <td>{{ item.supplier_name }}</td>
                                    <td class="expired-date">{{ item.expiry_date }}</td>
                                    <td class="days-expired">
                                        {% set expiry_date = item.expiry_date %}
                                        {% if expiry_date %}
                                            {% set days_expired = (expiry_date|string|days_since) %}
                                            {% if days_expired > 0 %}
                                                {{ days_expired }} days ago
                                            {% else %}
                                                Today
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ url_for('edit_product', id=item.id) }}" class="btn btn-sm btn-primary">Edit</a>
                                            <a href="{{ url_for('delete_product', id=item.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this expired product?')">Delete</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <h3>No Expired Items</h3>
                        <p>Great! All your products are within their expiry dates.</p>
                    </div>
                {% endif %}
            </section>
            
            <!-- Near Expiry Items Section -->
            <section class="expiry-section">
                <h2>‚ö†Ô∏è Items Near Expiry (Next 7 Days)</h2>
                {% if near_expiry_items %}
                    <div class="table-container">
                        <table class="expiry-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Supplier</th>
                                    <th>Expiry Date</th>
                                    <th>Days Until Expiry</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in near_expiry_items %}
                                <tr class="near-expiry-row">
                                    <td>{{ item.product_name }}</td>
                                    <td>{{ item.category }}</td>
                                    <td>{{ item.quantity }} {{ item.unit }}</td>
                                    <td>{{ item.supplier_name }}</td>
                                    <td class="near-expiry-date">{{ item.expiry_date }}</td>
                                    <td class="days-until">
                                        {% set expiry_date = item.expiry_date %}
                                        {% if expiry_date %}
                                            {% set days_until = (expiry_date|string|days_until) %}
                                            {% if days_until == 0 %}
                                                Today
                                            {% elif days_until == 1 %}
                                                Tomorrow
                                            {% else %}
                                                {{ days_until }} days
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ url_for('edit_product', id=item.id) }}" class="btn btn-sm btn-primary">Edit</a>
                                            <a href="{{ url_for('delete_product', id=item.id) }}" class="btn btn-sm btn-warning" onclick="return confirm('Are you sure you want to delete this product?')">Delete</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <h3>No Items Near Expiry</h3>
                        <p>Great! No products are expiring in the next 7 days.</p>
                    </div>
                {% endif %}
            </section>
            
            <!-- Recommendations -->
            <section class="recommendations">
                <h2>üí° Recommendations</h2>
                <div class="recommendation-cards">
                    <div class="recommendation-card">
                        <h3>üè∑Ô∏è Clearance Sale</h3>
                        <p>Consider offering discounts on near-expiry items to sell them quickly.</p>
                    </div>
                    <div class="recommendation-card">
                        <h3>üì¶ Stock Rotation</h3>
                        <p>Implement FIFO (First In, First Out) system to minimize waste.</p>
                    </div>
                    <div class="recommendation-card">
                        <h3>üìä Inventory Review</h3>
                        <p>Review ordering patterns to avoid overstocking perishable items.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        
        mobileMenuBtn.addEventListener('click', function() {
            sidebar.classList.toggle('active');
        });
        
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                    sidebar.classList.remove('active');
                }
            }
        });
        
        // Calculate days functions (these would normally be done in the backend)
        function calculateDaysExpired(expiryDate) {
            const expiry = new Date(expiryDate);
            const today = new Date();
            const diffTime = today - expiry;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        function calculateDaysUntilExpiry(expiryDate) {
            const expiry = new Date(expiryDate);
            const today = new Date();
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
    </script>
</body>
</html>
